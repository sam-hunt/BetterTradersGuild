RIMWORLD CONTAINER/STORAGE API - EXECUTIVE SUMMARY
===================================================

RESEARCH COMPLETED: Comprehensive analysis of RimWorld's storage architecture for the Better Traders Guild cargo system.

KEY FINDINGS:

1. TWO STORAGE PATTERNS
   - Building-based: Building_Storage (inherits from Verse.Building)
   - Component-based: CompThingContainer (ThingComp attached to buildings)
   For cargo bay: USE Building_Storage pattern

2. CONTAINER CLASSES

   a) Building_Storage
      - Interface: ISlotGroupParent, IStoreSettingsParent, IHaulDestination
      - Fields: StorageSettings, SlotGroup, StorageGroup
      - Best for: General storage like shelves
      - Capacity: Customizable via XML (3 items/cell for shelves)
      - Advantage: Automatic slot management, built-in haul system

   b) Building_Casket
      - Specialized for containment (cryptosleep caskets, coffins)
      - Interface: IThingHolder
      - Field: ThingOwner innerContainer (holds items)
      - Use case: Enclosed containers with open/close mechanics

   c) Building_Bookcase
      - Extends Building_Storage for books only
      - Filter: Only allows "Books" category
      - Max items: 5 books per cell
      - Special: Provides bonus to nearby academic work

   d) Building_OutfitStand
      - Extends Building_Storage for apparel
      - Filter: Only allows "Apparel" category (not utilities/weapons)
      - Capacity: Single outfit display
      - Special: Quick-change UI tabs

   e) CompThingContainer
      - Component-based (ThingComp subclass)
      - Field: ThingOwner innerContainer
      - Can be added to ANY building via XML
      - Properties: Empty, Full, TotalStackCount

3. THINGOWNER - CORE ITEM MANAGEMENT
   
   Class: Verse.ThingOwner (abstract base)
   Purpose: Universal list for managing items in containers

   Add Methods:
   - TryAdd(Thing item, int count) -> int (returns accepted count)
   - TryAddOrTransfer(Thing item) -> bool
   - TryAddRangeOrTransfer(IEnumerable<Thing>) -> void
   
   Check Methods:
   - CanAcceptAnyOf(Thing item) -> bool
   - GetCountCanAccept(Thing item) -> int
   
   Query Methods:
   - Count -> int
   - Item[index] -> Thing
   - Any -> bool
   - TotalStackCount -> int
   
   Removal Methods:
   - Remove(Thing item) -> bool
   - Clear() -> void
   - ClearAndDestroyContents(DestroyMode) -> void

4. STORAGE SETTINGS SYSTEM

   Class: RimWorld.StorageSettings
   
   Priority Levels (enum StoragePriority):
   - Unstored (0)
   - Low (1)
   - Normal (2)
   - Preferred (3)
   - Important (4)
   - Critical (5)
   
   Filtering: ThingFilter with categories
   Categories: Root, Foods, Manufactured, ResourcesRaw, Items, Weapons, Apparel, BodyParts, Books, Plants, Chunks, Buildings
   
   Two-Level XML Config:
   - fixedStorageSettings: Immutable constraints (always enforced)
   - defaultStorageSettings: Player-customizable defaults

5. XML DEFINITION PATTERNS

   For Shelf (Building_Storage):
   ```xml
   <thingClass>Building_Storage</thingClass>
   <storageGroupTag>Shelf</storageGroupTag>
   <maxItemsInCell>3</maxItemsInCell>
   <fixedStorageSettings>
     <filter>
       <disallowedCategories>
         <li>Chunks</li>
         <li>Plants</li>
         <li>Buildings</li>
       </disallowedCategories>
     </filter>
   </fixedStorageSettings>
   ```

   For Bookcase:
   - maxItemsInCell: 5
   - fixedStorageSettings filters to Books ONLY
   
   For Outfit Stand:
   - fixedStorageSettings filters to Apparel ONLY
   - Inspector tabs: ITab_Storage, ITab_ContentsOutfitStand

6. MAP GENERATION INTEGRATION

   Pattern for spawning with items:
   ```csharp
   // 1. Spawn building
   var storage = (Building_Storage)GenSpawn.Spawn(
       ThingMaker.MakeThing(buildingDef, stuff),
       position,
       map
   );
   
   // 2. Configure storage
   storage.settings.priority = StoragePriority.Important;
   storage.settings.filter.SetAllow(thingDef, true);
   
   // 3. Create items
   Thing item = ThingMaker.MakeThing(thingDef);
   item.stackCount = 100;
   
   // 4. Add to storage
   storage.slotGroup.HeldThings.TryAdd(item, true);
   ```

7. CRITICAL DIFFERENCES

   Shelves vs Bookshelves vs Outfit Stands:
   - Shelf: General (3 items/cell), all categories except chunks/plants/buildings
   - Bookcase: Specialized (5 items/cell), BOOKS ONLY, provides academic bonus
   - Outfit Stand: Specialized (1 outfit), APPAREL ONLY, quick-change UI
   
   Key Properties:
   - ignoreStoredThingsBeauty: false/true
   - preventDeteriorationOnTop: true/false
   - drawerType: For visual display

8. FOR CARGO BAY IMPLEMENTATION

   Recommendation: Use Building_Storage base class
   
   Cargo Bay XML:
   ```xml
   <thingClass>Building_Storage</thingClass>
   <storageGroupTag>CargoShuttleBay</storageGroupTag>
   <maxItemsInCell>3</maxItemsInCell>
   <fixedStorageSettings>
     <filter>
       <disallowNotEverStorable>true</disallowNotEverStorable>
       <disallowedCategories>
         <li>Chunks</li>
         <li>Plants</li>
         <li>Buildings</li>
       </disallowedCategories>
     </filter>
   </fixedStorageSettings>
   ```
   
   Dynamic Cargo Spawning:
   1. Get settlement's trade inventory (Settlement_TraderTracker.stock)
   2. Calculate cargo budget (inventory value × cargoPercentage)
   3. Randomly select items matching budget
   4. Spawn cargo bay building
   5. Add items to storage.slotGroup.HeldThings
   6. Remove from trade inventory (consumed)
   
   Anti-Exploit:
   - Track lastCargoRefreshTicks per settlement
   - Only refresh when trader rotates (after rotation interval)
   - Despawn old cargo → spawn new cargo
   - NOT refreshed on each visit (prevents exploits)
   
   Map Persistence:
   - Cargo is NOT generated with map (too variable)
   - Added dynamically when player enters map
   - Despawned/respawned when player leaves and returns
   - If rotation occurred, get new cargo from refreshed inventory

9. KEY INTERFACES

   ISlotGroupParent:
   - AllSlotCells() -> IEnumerable<IntVec3>
   - Notify_ReceivedThing(Thing)
   - Notify_LostThing(Thing)
   - GetSlotGroup() -> SlotGroup
   
   IStoreSettingsParent:
   - GetStoreSettings() -> StorageSettings
   - Notify_StorageSettingsChanged()
   
   IThingHolder:
   - GetDirectlyHeldThings() -> ThingOwner
   - GetChildHolders(List<IThingHolder>) -> void

10. SOURCE LOCATIONS

    RimWorld Assembly-CSharp.dll classes:
    - RimWorld.Building_Storage
    - RimWorld.Building_Casket
    - RimWorld.Building_Bookcase
    - RimWorld.CompThingContainer
    - Verse.ThingOwner
    - RimWorld.StorageSettings
    
    Example XMLs:
    - Core shelves: Data/Core/Defs/ThingDefs_Buildings/Buildings_Furniture.xml
    - Odyssey outfit stands: Data/Odyssey/Defs/ThingDefs_Buildings/Buildings_Furniture.xml

FULL DOCUMENTATION: See STORAGE_API_RESEARCH.md for complete class signatures, method parameters, and code examples.
